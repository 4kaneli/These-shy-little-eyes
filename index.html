<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shy Eyes — Blink to Reveal</title>
<style>
:root {
  --cols: 8;
  --rows: 5;
  --eye-size: 80px;
  --gap: 12px;
  --bg-color: #000000;
}
body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-color);
  color: #fff;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
.topbar {
  margin-bottom: 18px;
  text-align: center;
}
.topbar small { color: #bbb; display: block; margin-top:6px; }
.grid {
  display: grid;
  grid-template-columns: repeat(var(--cols), var(--eye-size));
  grid-auto-rows: var(--eye-size);
  gap: var(--gap);
  transform: translateZ(0);
}
.eye-wrap {
  width: var(--eye-size);
  height: var(--eye-size);
  display:flex;
  align-items:center;
  justify-content:center;
}
#videoPreview {
  position: fixed;
  right: 12px;
  top: 12px;
  width: 300px;
  height: 200;
  border-radius: 8px;
  display: none;
  z-index: 999;
}
.controls {
  margin-top: 18px;
  color: #ccc;
}
button { padding: 8px 12px; border-radius:6px; border: none; background:#1f6feb; color:white; cursor:pointer; }
button.secondary { background:#444; margin-left:8px; }
footer { margin-top:18px; color:#888; font-size:13px; }
</style>
</head>
<body>

<div class="topbar">
  <h2>“These shy little eyes.”</h2>
  <small>maybe if you don't look at them they will open...</small>
</div>

<div id="grid" class="grid"></div>

<video id="videoPreview" autoplay playsinline muted></video>

<div class="controls">
  <button id="startBtn">Start Webcam</button>
  <button id="stopBtn" class="secondary" disabled>Stop</button>
  <span style="margin-left:16px;color:#bbb">Threshold: <span id="thVal">0.22</span></span>
</div>

<footer>Based on MediaPipe FaceMesh — Timid eyes reveal.</footer>

<!-- blink sound -->
<audio id="blink-sound" src="blink.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
// CONFIG
const COLS = 8, ROWS = 5;
document.documentElement.style.setProperty('--cols', COLS);
document.documentElement.style.setProperty('--rows', ROWS);

const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const thValLabel = document.getElementById('thVal');
const videoPreview = document.getElementById('videoPreview');
const blinkSound = document.getElementById('blink-sound');

let camera = null, faceMesh = null, streamTrack = null, running = false;
let threshold = 0.22;
thValLabel.textContent = threshold.toFixed(2);

// colori iride
function randomColor(){
  const colors = ['#32CD32','#8B4513','#87CEEB'];
  return colors[Math.floor(Math.random()*colors.length)];
}

// crea occhio con palpebra interna
function makeEyeSVG(){
  const ns="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(ns,'svg');
  svg.setAttribute('viewBox','0 0 200 200');
  svg.setAttribute('width','100%');
  svg.setAttribute('height','100%');

  // sclera (senza contorno)
  const sclera = document.createElementNS(ns,'ellipse');
  sclera.setAttribute('cx',100);
  sclera.setAttribute('cy',100);
  sclera.setAttribute('rx',86);
  sclera.setAttribute('ry',56);
  sclera.setAttribute('fill','#fff');
  sclera.setAttribute('stroke','none');
  svg.appendChild(sclera);

  // iride
  const iris = document.createElementNS(ns,'circle');
  iris.setAttribute('cx',100);
  iris.setAttribute('cy',100);
  iris.setAttribute('r',32);
  iris.setAttribute('fill', randomColor());
  svg.appendChild(iris);

  // pupilla
  const pupil = document.createElementNS(ns,'circle');
  pupil.setAttribute('cx',100);
  pupil.setAttribute('cy',100);
  pupil.setAttribute('r',12);
  pupil.setAttribute('fill','#111');
  svg.appendChild(pupil);

  // palpebra interna
  const lid = document.createElementNS(ns,'ellipse');
  lid.setAttribute('cx',100);
  lid.setAttribute('cy',100);
  lid.setAttribute('rx',96);
  lid.setAttribute('ry',66);
  lid.setAttribute('fill','#000000');
  lid.style.transformOrigin='center top';
  lid.style.transition='transform 0.2s ease';
  svg.appendChild(lid);

  return {svg, lid};
}

// crea griglia
const eyes=[];
for(let r=0;r<ROWS;r++){
  for(let c=0;c<COLS;c++){
    const wrap=document.createElement('div');
    wrap.className='eye-wrap';
    const {svg,lid}=makeEyeSVG();
    wrap.appendChild(svg);
    grid.appendChild(wrap);
    eyes.push({wrap, svg, lid, opened:false});
  }
}

// EAR helper
function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y);}
function eyeAspectRatio(points){
  const [p1,p2,p3,p4,p5,p6]=points;
  const A=dist(p2,p6),B=dist(p3,p5),C=dist(p1,p4);
  return C===0?1.0:(A+B)/(2*C);
}
const LEFT=[33,160,158,133,153,144], RIGHT=[263,387,385,362,380,373];

// setup mediapipe
async function setupFaceMesh(){
  faceMesh=new FaceMesh({locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
  faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.6,minTrackingConfidence:0.5});
  faceMesh.onResults(onResults);
}

// callback ogni frame
function onResults(results){
  if(!results.multiFaceLandmarks || results.multiFaceLandmarks.length===0){
    setAllLids(false);
    return;
  }
  const lm=results.multiFaceLandmarks[0];
  const L=i=>({x:lm[i].x,y:lm[i].y});
  const leftPts=LEFT.map(L), rightPts=RIGHT.map(L);
  const ear=(eyeAspectRatio(leftPts)+eyeAspectRatio(rightPts))/2;
  const userEyesClosed=(ear<threshold);
  const openGrid=userEyesClosed; // invertito
  setAllLids(openGrid);
}

// mostra/nasconde palpebra e riproduce suono
function setAllLids(open){
  for(const e of eyes){
    if(open && !e.opened){
      blinkSound.currentTime=0;
      blinkSound.play().catch(()=>{});
      e.opened=true;
    }
    if(!open) e.opened=false;
    e.lid.style.transform=open?'scaleY(0)':'scaleY(1)';
  }
}

// start/stop webcam
async function startCamera(){
  if(running) return;
  await setupFaceMesh();
  const video=document.createElement('video');
  video.style.display='none';
  video.muted=true;
  video.playsInline=true;
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480},audio:false});
    streamTrack=stream.getTracks()[0];
    video.srcObject=stream;
    await video.play();
    videoPreview.srcObject=stream;
    videoPreview.style.display='block';
    camera=new Camera(video,{onFrame:async()=>{await faceMesh.send({image:video});},width:640,height:480});
    camera.start();
    running=true;
    startBtn.disabled=true;
    stopBtn.disabled=false;
  } catch(err){
    alert('Cannot access webcam: '+err.message);
    console.error(err);
  }
}

function stopCamera(){
  if(!running) return;
  if(camera) camera.stop();
  if(streamTrack) streamTrack.stop();
  videoPreview.style.display='none';
  running=false;
  startBtn.disabled=false;
  stopBtn.disabled=true;
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);
window.addEventListener('keydown', e=>{
  if(e.key==='ArrowUp'){threshold=Math.min(0.5,threshold+0.01);thValLabel.textContent=threshold.toFixed(2);}
  else if(e.key==='ArrowDown'){threshold=Math.max(0.05,threshold-0.01);thValLabel.textContent=threshold.toFixed(2);}
});

// inizialmente occhi chiusi
setAllLids(false);

</script>
</body>
</html>
